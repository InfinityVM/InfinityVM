// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

import {Test, console} from "forge-std/Test.sol";
import {JobManager} from "../src/JobManager.sol";
import {Consumer} from "../src/Consumer.sol";
import {MockConsumer} from "./mocks/MockConsumer.sol";
import {CoprocessorDeployer} from "../script/CoprocessorDeployer.s.sol";

contract CoprocessorTest is Test, CoprocessorDeployer {
    uint64 DEFAULT_MAX_CYCLES = 1_000_000;
    address RELAYER = address(1);
    address COPROCESSOR_OPERATOR = 0x184c47137933253f49325B851307Ab1017863BD0;
    address OFFCHAIN_SIGNER = 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266;
    bytes32 DEFAULT_JOB_ID;

    event JobCreated(bytes32 indexed jobID, uint64 maxCycles, bytes programID, bytes programInput);
    event JobCancelled(bytes32 indexed jobID);
    event JobCompleted(bytes32 indexed jobID, bytes result);

    function setUp() public {
        deployCoprocessorContracts(RELAYER, COPROCESSOR_OPERATOR, OFFCHAIN_SIGNER, false);
        DEFAULT_JOB_ID = keccak256(abi.encode(1, address(consumer)));
    }

    function test_JobManager_CreateJob() public {
        vm.expectEmit(true, true, true, true);
        emit JobCreated(DEFAULT_JOB_ID, DEFAULT_MAX_CYCLES, "programID", "programInput");
        bytes32 jobID = jobManager.createJob(1, "programID", "programInput", DEFAULT_MAX_CYCLES);
        assertEq(jobID, DEFAULT_JOB_ID);
        JobManager.JobMetadata memory jobMetadata = jobManager.getJobMetadata(jobID);
        assertEq(jobMetadata.programID, "programID");
        assertEq(jobMetadata.maxCycles, DEFAULT_MAX_CYCLES);
        assertEq(jobMetadata.caller, address(this));
        assertEq(jobMetadata.status, 1);
    }

    function test_Consumer_RequestJob() public {
        vm.expectEmit(true, true, true, true);
        emit JobCreated(DEFAULT_JOB_ID, DEFAULT_MAX_CYCLES, "programID", abi.encode(address(0)));
        bytes32 jobID = consumer.requestBalance("programID", address(0));
        assertEq(jobID, DEFAULT_JOB_ID);
        assertEq(consumer.getProgramInputsForJob(jobID), abi.encode(address(0)));
        JobManager.JobMetadata memory jobMetadata = jobManager.getJobMetadata(jobID);
        assertEq(jobMetadata.programID, "programID");
        assertEq(jobMetadata.maxCycles, DEFAULT_MAX_CYCLES);
        assertEq(jobMetadata.caller, address(consumer));
        assertEq(jobMetadata.status, 1);
    }

    function test_JobManager_CancelJobByConsumer() public {
        test_Consumer_RequestJob();
        vm.expectEmit(true, false, false, false);
        emit JobCancelled(DEFAULT_JOB_ID);
        vm.prank(address(consumer));
        jobManager.cancelJob(DEFAULT_JOB_ID);
        JobManager.JobMetadata memory jobMetadata = jobManager.getJobMetadata(DEFAULT_JOB_ID);
        assertEq(jobMetadata.status, 2);
    }

    function test_JobManager_CancelJobByOwner() public {
        test_Consumer_RequestJob();
        vm.expectEmit(true, false, false, false);
        emit JobCancelled(DEFAULT_JOB_ID);
        vm.prank(jobManager.owner());
        jobManager.cancelJob(DEFAULT_JOB_ID);
        JobManager.JobMetadata memory jobMetadata = jobManager.getJobMetadata(DEFAULT_JOB_ID);
        assertEq(jobMetadata.status, 2);
    }

    function testRevertWhen_JobManager_CancelJobUnauthorized() public {
        test_JobManager_CreateJob();
        vm.prank(address(1));
        vm.expectRevert("JobManager.cancelJob: caller is not the job creator or JobManager owner");
        jobManager.cancelJob(DEFAULT_JOB_ID);
    }

    function testRevertWhen_JobManager_CancelJobNotPending() public {
        test_Consumer_RequestJob();
        vm.prank(address(consumer));
        jobManager.cancelJob(DEFAULT_JOB_ID);
        vm.prank(address(consumer));
        vm.expectRevert("JobManager.cancelJob: job is not in pending state");
        jobManager.cancelJob(DEFAULT_JOB_ID);
    }

    function testRevertWhen_Consumer_ReceiveResultUnauthorized() public {
        test_Consumer_RequestJob();
        vm.prank(address(1));
        vm.expectRevert("Consumer.onlyJobManager: caller is not the job manager");
        consumer.receiveResult(DEFAULT_JOB_ID, abi.encode(address(0)));
    }

    function test_JobManager_SubmitResult() public {
        test_Consumer_RequestJob();

        // Generated using rust/crates/scripts/signer.rs
        bytes memory resultWithMetadata = hex"0000000000000000000000000000000000000000000000000000000000000001290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e56300000000000000000000000000000000000000000000000000000000000f424000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000970726f6772616d4944000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a";
        bytes memory signature = hex"88db44d83f6d32ff87647d9ac8d468b74ac6afdbc76f4ee7cc9260f93e3e48c9617f4ed3e7088e529a78c481fa9d58affb166dbb388e300e42c3de4e7b54d6091b";

        vm.expectEmit(true, true, false, false);
        emit JobCompleted(DEFAULT_JOB_ID, abi.encode(address(0), 10));
        vm.prank(RELAYER);
        jobManager.submitResult(resultWithMetadata, signature);

        JobManager.JobMetadata memory jobMetadata = jobManager.getJobMetadata(DEFAULT_JOB_ID);
        // Check that job status is COMPLETED
        assertEq(jobMetadata.status, 3);

        // Check that state was correctly updated in Consumer contract
        assertEq(consumer.getBalance(address(0)), 10);
        assertEq(consumer.getJobResult(DEFAULT_JOB_ID), abi.encode(address(0), 10));
    }

    function testFailWhen_JobManager_SubmitResultInvalidEncodingOfResultWithMetadata() public {
        test_Consumer_RequestJob();

        // Generated using rust/crates/scripts/signer.rs but with invalid ABI-encoding
        bytes memory resultWithMetadata = hex"000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000970726f6772616d4944000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a";
        bytes memory signature = hex"0f04250c720cdeffaf148e5af16a5f963c4f3faf6f85c638ac22c02db613d427112cca027fb7c48ad36e1aee504e85d2c76c7edff3e99a9ad9b07815eeb979a01b";

        vm.prank(RELAYER);
        jobManager.submitResult(resultWithMetadata, signature);
    }

    function testFailWhen_JobManager_SubmitResultInvalidEncodingOfResult() public {
        test_Consumer_RequestJob();

        // Generated using rust/crates/scripts/signer.rs but with invalid ABI-encoding
        bytes memory resultWithMetadata = hex"0000000000000000000000000000000000000000000000000000000000000001290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e56300000000000000000000000000000000000000000000000000000000000f424000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000970726f6772616d494400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000a";
        bytes memory signature = hex"3c16a16c38396707abc541a25c450b794b36bcb1d2d77368c394745aa3a66b2c20ef2edd3674fda414ea4c6968db006791b94407d28c9ae6178b535d7b58235d1c";

        vm.prank(RELAYER);
        jobManager.submitResult(resultWithMetadata, signature);
    }

    function testRevertWhen_JobManager_SubmitResultUnauthorized() public {
        test_Consumer_RequestJob();
        vm.prank(address(2));
        vm.expectRevert("JobManager.submitResult: caller is not the relayer");
        jobManager.submitResult(abi.encode("resultWithMetadata"), abi.encodePacked("signature"));
    }

    function testRevertWhen_JobManager_SubmitResultInvalidSignature() public {
        test_Consumer_RequestJob();

        bytes memory resultWithMetadata = hex"0000000000000000000000000000000000000000000000000000000000000001290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e56300000000000000000000000000000000000000000000000000000000000f424000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000970726f6772616d4944000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a";
        bytes memory signature = hex"89db44d83f6d32ff87647d9ac8d468b74ac6afdbc76f4ee7cc9260f93e3e48c9617f4ed3e7088e529a78c481fa9d58affb166dbb388e300e42c3de4e7b54d6091b";

        vm.expectRevert("JobManager.submitResult: Invalid signature");
        vm.prank(RELAYER);
        jobManager.submitResult(resultWithMetadata, signature);
    }

    function testRevertWhen_JobManager_SubmitResultCancelledJob() public {
        test_JobManager_CancelJobByConsumer();

        bytes memory resultWithMetadata = hex"0000000000000000000000000000000000000000000000000000000000000001290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e56300000000000000000000000000000000000000000000000000000000000f424000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000970726f6772616d4944000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a";
        bytes memory signature = hex"88db44d83f6d32ff87647d9ac8d468b74ac6afdbc76f4ee7cc9260f93e3e48c9617f4ed3e7088e529a78c481fa9d58affb166dbb388e300e42c3de4e7b54d6091b";

        vm.expectRevert("JobManager.submitResult: job is not in pending state");
        vm.prank(RELAYER);
        jobManager.submitResult(resultWithMetadata, signature);
    }

    function testRevertWhen_JobManager_SubmitResultWrongProgramInputHash() public {
        test_Consumer_RequestJob();

        bytes memory resultWithMetadata = hex"0000000000000000000000000000000000000000000000000000000000000001e570eff78be1b11cf36ef150c7ed13e3fa520033b0a14059887fc69332fb4c3300000000000000000000000000000000000000000000000000000000000f424000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000970726f6772616d4944000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a";
        bytes memory signature = hex"599c86688b587cfdd46d187e2a6ccac8aba11d546e3844846ffd9e7ac008ddc84c136b66eda5d1ff9bf440cde2c2793f905807ffd57722fb1db8bdbef74eed1f1b";

        vm.expectRevert("JobManager.submitResult: program input signed by coprocessor doesn't match program input submitted with job");
        vm.prank(RELAYER);
        jobManager.submitResult(resultWithMetadata, signature);
    }

    function testRevertWhen_JobManager_SubmitResultWrongProgramID() public {
        test_Consumer_RequestJob();

        bytes memory resultWithMetadata = hex"0000000000000000000000000000000000000000000000000000000000000001290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e56300000000000000000000000000000000000000000000000000000000000f424000000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000c70726f6772616d4944313233000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a";
        bytes memory signature = hex"1e84e7839672b237541a76feac1ba35e179ab8a325f4c66ca135d7c5ebea3061525e718e2e5f0a5a9803d0e4717bbbad990376874312db3f0db5ce2bed6980ef1b";

        vm.expectRevert("JobManager.submitResult: program ID signed by coprocessor doesn't match program ID submitted with job");
        vm.prank(RELAYER);
        jobManager.submitResult(resultWithMetadata, signature);
    }

    function testRevertWhen_JobManager_SubmitResultWrongMaxCycles() public {
        test_Consumer_RequestJob();

        bytes memory resultWithMetadata = hex"0000000000000000000000000000000000000000000000000000000000000001290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e563000000000000000000000000000000000000000000000000000000000000003200000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000970726f6772616d4944000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a";
        bytes memory signature = hex"0bef1eca23f5c63d03092980801d768940cda44fbd478f4c2ef7a430eff464322c2ecf214d1f153e9a80c6b7c25f2f68d90b94f96190d3dd13de715085d7bd1f1b";

        vm.expectRevert("JobManager.submitResult: max cycles signed by coprocessor doesn't match max cycles submitted with job");
        vm.prank(RELAYER);
        jobManager.submitResult(resultWithMetadata, signature);
    }

    function test_JobManager_SubmitResultForOffchainJob() public {
        // Generated using rust/crates/scripts/signer.rs
        bytes memory jobRequest = hex"000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000db8cff278adccf9e9b5da745b44e754fc4ee3c7600000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000970726f6772616d4944000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000";
        bytes memory signatureOnRequest = hex"9d082fb40fa6afaa0da743eb5b17a0efe5b7a53fb152615fc7740625a26770296c1896427379cfe894bad3b6662edb440323b4b7835beaa9e647360e055dbdac1b";

        bytes memory offchainResultWithMetadata = hex"290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e56300000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000970726f6772616d4944000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a";
        bytes memory signatureOnResult = hex"b3e4536ee1991fec6a009a0df362b8b55a9f2b304d4d94f34a71e81203be3274679ec32fe27c3c7340664bd5c8c7855c8957c371e445b80fe693f381688894fb1c";

        vm.expectEmit(true, true, false, false);
        emit JobCompleted(DEFAULT_JOB_ID, abi.encode(address(0), 10));
        vm.prank(RELAYER);
        jobManager.submitResultForOffchainJob(offchainResultWithMetadata, signatureOnResult, jobRequest, signatureOnRequest);

        // Check that inputs are stored correctly in Consumer contract
        assertEq(consumer.getProgramInputsForJob(DEFAULT_JOB_ID), abi.encode(address(0)));

        // // Check that nonce-related data is stored correctly in JobManager contract
        // assertEq(jobManager.getJobIDForNonce(DEFAULT_JOB_ID, address(consumer)), 1);
        // assertEq(jobManager.getMaxNonce(address(consumer)), 1);

        JobManager.JobMetadata memory jobMetadata = jobManager.getJobMetadata(DEFAULT_JOB_ID);
        // Check that job status is COMPLETED
        assertEq(jobMetadata.status, 3);

        // Check that state was correctly updated in Consumer contract
        assertEq(consumer.getBalance(address(0)), 10);
        assertEq(consumer.getJobResult(DEFAULT_JOB_ID), abi.encode(address(0), 10));
    }

    function testFailWhen_JobManager_SubmitResultForOffchainJobInvalidEncodingOfRequest() public {
        // Generated using rust/crates/scripts/signer.rs but with invalid ABI-encoding
        bytes memory jobRequest = hex"0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000db8cff278adccf9e9b5da745b44e754fc4ee3c76000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000970726f6772616d4944000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000";
        bytes memory signatureOnRequest = hex"63427b34c5cbd6673dee562772d6e8129d7f6f0857fa32abbec6a787537002e73e5a52f9d79148828e47af4c855c7f870d226fdbcff0d44526d28107c02f92311b";

        bytes memory offchainResultWithMetadata = hex"290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e56300000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000970726f6772616d4944000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a";
        bytes memory signatureOnResult = hex"b3e4536ee1991fec6a009a0df362b8b55a9f2b304d4d94f34a71e81203be3274679ec32fe27c3c7340664bd5c8c7855c8957c371e445b80fe693f381688894fb1c";

        vm.prank(RELAYER);
        jobManager.submitResultForOffchainJob(offchainResultWithMetadata, signatureOnResult, jobRequest, signatureOnRequest);
    }

    function testRevertWhen_JobManager_SubmitResultForOffchainJobDuplicateNonce() public {
        test_JobManager_SubmitResultForOffchainJob();

        // Generated using rust/crates/scripts/signer.rs
        bytes memory jobRequest = hex"000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000db8cff278adccf9e9b5da745b44e754fc4ee3c7600000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000970726f6772616d4944000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000";
        bytes memory signatureOnRequest = hex"9d082fb40fa6afaa0da743eb5b17a0efe5b7a53fb152615fc7740625a26770296c1896427379cfe894bad3b6662edb440323b4b7835beaa9e647360e055dbdac1b";

        bytes memory offchainResultWithMetadata = hex"290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e56300000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000970726f6772616d4944000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a";
        bytes memory signatureOnResult = hex"b3e4536ee1991fec6a009a0df362b8b55a9f2b304d4d94f34a71e81203be3274679ec32fe27c3c7340664bd5c8c7855c8957c371e445b80fe693f381688894fb1c";

        vm.expectRevert("JobManager.submitResultForOffchainJob: Nonce already exists for this consumer");
        vm.prank(RELAYER);
        jobManager.submitResultForOffchainJob(offchainResultWithMetadata, signatureOnResult, jobRequest, signatureOnRequest);
    }

    function testRevertWhen_JobManager_SubmitResultForOffchainJobInvalidSignatureOnRequest() public {
        // Generated using rust/crates/scripts/signer.rs
        bytes memory jobRequest = hex"000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000db8cff278adccf9e9b5da745b44e754fc4ee3c7600000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000970726f6772616d4944000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000";
        bytes memory invalidSignatureOnRequest = hex"8d082fb40fa6afaa0da743eb5b17a0efe5b7a53fb152615fc7740625a26770296c1896427379cfe894bad3b6662edb440323b4b7835beaa9e647360e055dbdac1b";

        bytes memory offchainResultWithMetadata = hex"290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e56300000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000970726f6772616d4944000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a";
        bytes memory signatureOnResult = hex"b3e4536ee1991fec6a009a0df362b8b55a9f2b304d4d94f34a71e81203be3274679ec32fe27c3c7340664bd5c8c7855c8957c371e445b80fe693f381688894fb1c";

        vm.expectRevert("JobManager.submitResultForOffchainJob: Invalid signature on job request");
        vm.prank(RELAYER);
        jobManager.submitResultForOffchainJob(offchainResultWithMetadata, signatureOnResult, jobRequest, invalidSignatureOnRequest);
    }

    function testRevertWhen_JobManager_SubmitResultForOffchainJobInvalidSignatureOnResult() public {
        // Generated using rust/crates/scripts/signer.rs
        bytes memory jobRequest = hex"000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000db8cff278adccf9e9b5da745b44e754fc4ee3c7600000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000970726f6772616d4944000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000";
        bytes memory signatureOnRequest = hex"9d082fb40fa6afaa0da743eb5b17a0efe5b7a53fb152615fc7740625a26770296c1896427379cfe894bad3b6662edb440323b4b7835beaa9e647360e055dbdac1b";

        bytes memory offchainResultWithMetadata = hex"290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e56300000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000970726f6772616d4944000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a";
        bytes memory invalidSignatureOnResult = hex"d3e4536ee1991fec6a009a0df362b8b55a9f2b304d4d94f34a71e81203be3274679ec32fe27c3c7340664bd5c8c7855c8957c371e445b80fe693f381688894fb1c";

        vm.expectRevert("JobManager.submitResultForOffchainJob: Invalid signature on result");
        vm.prank(RELAYER);
        jobManager.submitResultForOffchainJob(offchainResultWithMetadata, invalidSignatureOnResult, jobRequest, signatureOnRequest);
    }

    function testRevertWhen_JobManager_SubmitResultForOffchainJobWrongProgramInputHash() public {
        // Generated using rust/crates/scripts/signer.rs
        bytes memory jobRequest = hex"000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000db8cff278adccf9e9b5da745b44e754fc4ee3c7600000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000970726f6772616d4944000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000";
        bytes memory signatureOnRequest = hex"9d082fb40fa6afaa0da743eb5b17a0efe5b7a53fb152615fc7740625a26770296c1896427379cfe894bad3b6662edb440323b4b7835beaa9e647360e055dbdac1b";

        bytes memory offchainResultWithMetadata = hex"510e4e770828ddbf7f7b00ab00a9f6adaf81c0dc9cc85f1f8249c256942d61d900000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000970726f6772616d4944000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a";
        bytes memory signatureOnResult = hex"cd48f2626c2882d4a2ad41c4ede41388e1ec1eb0d25df112b6b66e5df6a58df235622fabf3cab240326a173570699b60eb94cb3b4337d4d19e73729b501d7a861c";

        vm.expectRevert("JobManager.submitResult: program input signed by coprocessor doesn't match program input submitted with job");
        vm.prank(RELAYER);
        jobManager.submitResultForOffchainJob(offchainResultWithMetadata, signatureOnResult, jobRequest, signatureOnRequest);
    }

    function testRevertWhen_JobManager_SubmitResultForOffchainJobWrongProgramID() public {
        // Generated using rust/crates/scripts/signer.rs
        bytes memory jobRequest = hex"000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000db8cff278adccf9e9b5da745b44e754fc4ee3c7600000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000970726f6772616d4944000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000";
        bytes memory signatureOnRequest = hex"9d082fb40fa6afaa0da743eb5b17a0efe5b7a53fb152615fc7740625a26770296c1896427379cfe894bad3b6662edb440323b4b7835beaa9e647360e055dbdac1b";

        bytes memory offchainResultWithMetadata = hex"290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e56300000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000a70726f6772616d4944350000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a";
        bytes memory signatureOnResult = hex"15a3439fd56c9e17918c96b19f0eed91c62c77c4aed3f01f0ad8b399ef8db3c060d864fa1d085bc91b17d4ebba1df7c2c36bd5e84b097378caf00a701bd4ace21b";

        vm.expectRevert("JobManager.submitResult: program ID signed by coprocessor doesn't match program ID submitted with job");
        vm.prank(RELAYER);
        jobManager.submitResultForOffchainJob(offchainResultWithMetadata, signatureOnResult, jobRequest, signatureOnRequest);
    }

    function testRevertWhen_JobManager_SubmitResultForOffchainJobWrongMaxCycles() public {
        // Generated using rust/crates/scripts/signer.rs
        bytes memory jobRequest = hex"000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000db8cff278adccf9e9b5da745b44e754fc4ee3c7600000000000000000000000000000000000000000000000000000000000000a000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000000970726f6772616d4944000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000";
        bytes memory signatureOnRequest = hex"9d082fb40fa6afaa0da743eb5b17a0efe5b7a53fb152615fc7740625a26770296c1896427379cfe894bad3b6662edb440323b4b7835beaa9e647360e055dbdac1b";

        bytes memory offchainResultWithMetadata = hex"290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e5630000000000000000000000000000000000000000000000000000000005f5f488000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000c0000000000000000000000000000000000000000000000000000000000000000970726f6772616d4944000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a";
        bytes memory signatureOnResult = hex"bcba3754f00b5c44e8cef2ed4cdc93c63ebbc42d6a019405714c0328c131324b303733e51bf3c7286be2177f0aeba68b1e43b3298e569fb00097924158c0ca531b";

        vm.expectRevert("JobManager.submitResult: max cycles signed by coprocessor doesn't match max cycles submitted with job");
        vm.prank(RELAYER);
        jobManager.submitResultForOffchainJob(offchainResultWithMetadata, signatureOnResult, jobRequest, signatureOnRequest);
    }
}


